{% extends "base.html" %}

{% block title %}Dashboard - Invitados{% endblock %}

{% block page_css %}
<style>
    .dashboard-container {
        padding: 120px 20px 60px;
        max-width: 1200px;
        margin: 0 auto;
        color: #fff;
    }

    h1 {
        text-align: center;
        margin-bottom: 40px;
        color: #ffffff;
    }

    .toolbar {
        margin-bottom: 20px;
        text-align: right;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
        border: none;
        text-decoration: none;
        display: inline-block;
    }

    .btn-add {
        background: #28a745;
        color: white;
    }

    .btn-save {
        background: #007bff;
        color: white;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
        padding: 5px 10px;
        font-size: 0.8rem;
    }

    .guests-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }

    .guests-table th,
    .guests-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .guests-table th {
        background: rgba(0, 0, 0, 0.3);
        color: #4885EA;
    }

    .guests-table input {
        width: 100%;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 4px;
    }

    .message {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        text-align: center;
        display: none;
    }

    .message.success {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid #28a745;
    }

    .message.error {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }

        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div id="statusMessage" class="message"></div>

    <h1>Gestión de Fundadores (Hero)</h1>

    <div style="margin-bottom: 30px;">
        <label style="display: block; margin-bottom: 10px; color: #4885EA; font-weight: bold;">Texto descriptivo del
            Hero:</label>
        <textarea id="heroSubtitleText"
            style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 4px; font-family: inherit; min-height: 80px;"
            placeholder="Escribe el texto descriptivo del podcast...">{{ hero_subtitle }}</textarea>
    </div>

    <div class="toolbar">
        <button class="btn btn-add" onclick="addFounder()">+ Añadir Fundador</button>
        <button class="btn btn-save" onclick="saveFounders()">Guardar Fundadores</button>
    </div>

    <table class="guests-table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Enlace</th>
                <th>Imagen (130x130)</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="foundersTableBody">
            {% for founder in fundadores %}
            <tr>
                <td><input type="text" value="{{ founder.name }}" class="founder-name"></td>
                <td><input type="text" value="{{ founder.link }}" class="founder-link" placeholder="https://..."></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="{{ url_for('static', filename='images/fundadores/' + founder.image) }}"
                            style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid white;"
                            class="founder-preview" width="50" height="50">
                        <input type="file" onchange="uploadFounderImage(this)" style="display: none;"
                            class="file-input">
                        <button class="btn btn-save" onclick="this.previousElementSibling.click()"
                            style="padding: 5px 10px; font-size: 0.8rem;">Subir</button>
                        <input type="hidden" value="{{ founder.image }}" class="founder-image">
                    </div>
                </td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="margin-top: 60px; margin-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
        Gestión de Invitados Destacados</h2>

    <div class="toolbar">
        <button class="btn btn-add" onclick="addGuest()">+ Añadir Invitado</button>
        <button class="btn btn-save" onclick="saveChanges()">Guardar Cambios</button>
    </div>

    <table class="guests-table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Rol / Título</th>
                <th>Imagen</th>
                <th>LinkedIn URL</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="guestsTableBody">
            {% for guest in guests %}
            <tr>
                <td><input type="text" value="{{ guest.name }}" class="guest-name"></td>
                <td><input type="text" value="{{ guest.role }}" class="guest-role"></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="{{ url_for('static', filename='images/' + guest.image) }}"
                            style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                            class="guest-preview" width="40" height="40">
                        <input type="file" onchange="uploadImage(this)" style="display: none;" class="file-input">
                        <button class="btn btn-save" onclick="this.previousElementSibling.click()"
                            style="padding: 5px 10px; font-size: 0.8rem;">Subir</button>
                        <input type="hidden" value="{{ guest.image }}" class="guest-image">
                    </div>
                </td>
                <td><input type="text" value="{{ guest.linkedin }}" class="guest-linkedin"></td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="margin-top: 60px; margin-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
        Gestión de Colaboradores</h2>

    <div class="toolbar">
        <button class="btn btn-add" onclick="addCollaborator()">+ Añadir Colaborador</button>
        <button class="btn btn-save" onclick="saveCollaborators()">Guardar Colaboradores</button>
    </div>

    <table class="guests-table">
        <thead>
            <tr>
                <th>Nombre Empresa/Entidad</th>
                <th>URL Web</th>
                <th>Imagen (Logo)</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="collaboratorsTableBody">
            {% for colab in colaboradores %}
            <tr>
                <td><input type="text" value="{{ colab.name }}" class="colab-name"></td>
                <td><input type="text" value="{{ colab.url }}" class="colab-url"></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="{{ url_for('static', filename='images/' + colab.image) }}"
                            style="width: 40px; height: 40px; object-fit: contain; background: white; padding: 2px; border-radius: 4px;"
                            class="colab-preview" width="40" height="40">
                        <input type="file" onchange="uploadCollaboratorImage(this)" style="display: none;"
                            class="file-input">
                        <button class="btn btn-save" onclick="this.previousElementSibling.click()"
                            style="padding: 5px 10px; font-size: 0.8rem;">Subir</button>
                        <input type="hidden" value="{{ colab.image }}" class="colab-image">
                    </div>
                </td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="margin-top: 60px; margin-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
        Gestión de Newsletters</h2>

    <div class="toolbar">
        <button class="btn btn-add" onclick="addNewsletter()">+ Añadir Newsletter</button>
        <button class="btn btn-save" onclick="saveNewsletters()">Guardar Newsletters</button>
    </div>



    <table class="guests-table">
        <thead>
            <tr>
                <th>Badge</th>
                <th>Clase (Color)</th>
                <th>Fecha</th>
                <th>Título</th>
                <th>Descripción</th>
                <th>Destacados (Icono|Texto por linea)</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="newslettersTableBody">
            {% for news in newsletters %}
            <tr>
                <td><input type="text" value="{{ news.badge }}" class="news-badge"></td>
                <td>
                    <select class="news-badge-class">
                        <option value="alert" {% if news.badge_class=='alert' %}selected{% endif %}>Alert (Rojo)
                        </option>
                        <option value="tech" {% if news.badge_class=='tech' %}selected{% endif %}>Tech (Azul)</option>
                        <option value="compliance" {% if news.badge_class=='compliance' %}selected{% endif %}>Compliance
                            (Verde)</option>
                        <option value="incident" {% if news.badge_class=='incident' %}selected{% endif %}>Incidente
                            (Naranja)</option>
                    </select>
                </td>
                <td><input type="text" value="{{ news.date }}" class="news-date"></td>
                <td><input type="text" value="{{ news.title }}" class="news-title"></td>
                <td><textarea class="news-desc" rows="3">{{ news.description }}</textarea></td>
                <td>
                    <textarea class="news-highlights" rows="3"
                        placeholder="fas fa-icon|Texto">{% for h in news.highlights %}{{ h.icon }}|{{ h.text }}{{ "\n" if not loop.last else "" }}{% endfor %}</textarea>
                </td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


    <h2 style="margin-top: 60px; margin-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
        Gestión de Recomendaciones de Invitados</h2>

    <div class="toolbar">
        <button class="btn btn-add" onclick="addRecommendation()">+ Añadir Recomendación</button>
        <button class="btn btn-save" onclick="saveRecommendations()">Guardar Recomendaciones</button>
    </div>

    <table class="guests-table">
        <thead>
            <tr>
                <th>Nombre Invitado</th>
                <th>Título Episodio / Detalle</th>
                <th>Texto de Recomendación</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="recommendationsTableBody">
            {% for rec in recomendaciones %}
            <tr>
                <td><input type="text" value="{{ rec.guest_name }}" class="rec-guest"></td>
                <td><input type="text" value="{{ rec.episode_title }}" class="rec-title"></td>
                <td><textarea class="rec-text"
                        style="width: 100%; background: #2a2a3b; border: 1px solid #444; color: #fff; border-radius: 4px; padding: 5px;">{{ rec.recommendation_text }}</textarea>
                </td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="margin-top: 60px; margin-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
        Gestión de Estadísticas</h2>

    <div class="toolbar">
        <button class="btn btn-add" onclick="addStat()">+ Añadir Estadística</button>
        <button class="btn btn-save" onclick="saveStats()">Guardar Estadísticas</button>
    </div>

    <table class="guests-table">
        <thead>
            <tr>
                <th>Número/Valor</th>
                <th>Etiqueta/Descripción</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="statsTableBody">
            {% for stat in estadisticas %}
            <tr>
                <td><input type="text" value="{{ stat.number }}" class="stat-number"></td>
                <td><input type="text" value="{{ stat.label }}" class="stat-label"></td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="margin-top: 60px; margin-bottom: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
        Gestión de Sección "Quiénes Somos"</h2>

    <div class="toolbar">
        <button class="btn btn-save" onclick="saveAbout()">Guardar Quiénes Somos</button>
    </div>

    <div style="margin-bottom: 30px;">
        <h3 style="color: #4885EA; margin-bottom: 15px;">Párrafos de la sección</h3>
        <div id="aboutParagraphsContainer">
            {% for paragraph in about_data.paragraphs %}
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7);">Párrafo {{ loop.index
                    }}:</label>
                <textarea class="about-paragraph"
                    style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 4px; font-family: inherit; min-height: 100px;">{{ paragraph.text }}</textarea>
                <button class="btn btn-delete" onclick="deleteAboutParagraph(this)" style="margin-top: 5px;">Eliminar
                    Párrafo</button>
            </div>
            {% endfor %}
        </div>
        <button class="btn btn-add" onclick="addAboutParagraph()">+ Añadir Párrafo</button>
    </div>

    <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
        <h3 style="color: #4885EA; margin-bottom: 15px;">Premio / Reconocimiento</h3>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7);">Texto
                introductorio:</label>
            <input type="text" id="awardIntro" value="{{ about_data.award.intro if about_data.award else '' }}"
                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 4px;"
                placeholder="Ej: Nos enorgullece compartir que...">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7);">URL del
                reconocimiento:</label>
            <input type="text" id="awardUrl" value="{{ about_data.award.url if about_data.award else '' }}"
                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 4px;"
                placeholder="https://...">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7);">Título del premio:</label>
            <input type="text" id="awardTitle" value="{{ about_data.award.title if about_data.award else '' }}"
                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 4px;"
                placeholder="Ej: Premio Blue Talent In-Cansables">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7);">Subtítulo del
                premio:</label>
            <input type="text" id="awardSubtitle" value="{{ about_data.award.subtitle if about_data.award else '' }}"
                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 4px;"
                placeholder="Ej: Mejor Podcast (Septiembre)">
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    // --- Founders Logic ---
    function addFounder() {
        const tbody = document.getElementById('foundersTableBody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="Nombre" class="founder-name"></td>
            <td><input type="text" value="" class="founder-link" placeholder="https://..."></td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                   <img src="/static/images/logo.webp" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid white;" class="founder-preview" width="50" height="50">
                   <input type="file" onchange="uploadFounderImage(this)" style="display: none;" class="file-input">
                   <button class="btn btn-save" onclick="this.previousElementSibling.click()" style="padding: 5px 10px; font-size: 0.8rem;">Subir</button>
                   <input type="hidden" value="logo.webp" class="founder-image">
                </div>
            </td>
            <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    }

    async function uploadFounderImage(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const row = input.closest('tr');
        const hiddenInput = row.querySelector('.founder-image');
        const previewImg = row.querySelector('.founder-preview');
        const oldFilename = hiddenInput.value;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('old_filename', oldFilename);
        formData.append('csrf_token', getCsrfToken());

        const msg = document.getElementById('statusMessage');
        msg.style.display = 'block';
        msg.textContent = 'Subiendo imagen...';
        msg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/upload_founder_image', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                hiddenInput.value = data.filepath.split('/').pop();

                previewImg.src = '/static/images/' + data.filepath;

                msg.textContent = 'Imagen subida. ¡Pulsa "Guardar Fundadores"!';
                msg.className = 'message success';
            } else {
                throw new Error(data.error || 'Error al subir');
            }
        } catch (error) {
            msg.textContent = 'Error: ' + error.message;
            msg.classList.add('error');
        }
    }

    async function saveFounders() {
        const rows = document.querySelectorAll('#foundersTableBody tr');
        const founders = [];

        rows.forEach(row => {
            founders.push({
                name: row.querySelector('.founder-name').value,
                link: row.querySelector('.founder-link').value,
                image: row.querySelector('.founder-image').value
            });
        });

        const heroSubtitle = document.getElementById('heroSubtitleText').value;

        const statusMsg = document.getElementById('statusMessage');
        statusMsg.style.display = 'block';
        statusMsg.textContent = 'Guardando fundadores...';
        statusMsg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/save_founders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    hero_subtitle: heroSubtitle,
                    founders: founders
                })
            });

            const data = await response.json();

            if (data.success) {
                statusMsg.textContent = '¡Fundadores guardados correctamente!';
                statusMsg.classList.add('success');
                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            statusMsg.textContent = 'Error al guardar: ' + error.message;
            statusMsg.classList.add('error');
        }
    }

    // --- Recommendations Logic ---
    function addRecommendation() {
        const tbody = document.getElementById('recommendationsTableBody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="Nombre Invitado" class="rec-guest"></td>
            <td><input type="text" value="Título Episodio" class="rec-title"></td>
            <td><textarea class="rec-text" style="width: 100%; background: #2a2a3b; border: 1px solid #444; color: #fff; border-radius: 4px; padding: 5px;">Texto de recomendación...</textarea></td>
            <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    }

    async function saveRecommendations() {
        const rows = document.querySelectorAll('#recommendationsTableBody tr');
        const recs = [];

        rows.forEach(row => {
            recs.push({
                guest_name: row.querySelector('.rec-guest').value,
                episode_title: row.querySelector('.rec-title').value,
                recommendation_text: row.querySelector('.rec-text').value
            });
        });

        const statusMsg = document.getElementById('statusMessage');
        statusMsg.style.display = 'block';
        statusMsg.textContent = 'Guardando recomendaciones...';
        statusMsg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/save_recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(recs)
            });

            const data = await response.json();

            if (data.success) {
                statusMsg.textContent = '¡Recomendaciones guardadas correctamente!';
                statusMsg.classList.add('success');
                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            statusMsg.textContent = 'Error al guardar: ' + error.message;
            statusMsg.classList.add('error');
        }
    }

    function addStat() {
        const tbody = document.getElementById('statsTableBody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="0" class="stat-number"></td>
            <td><input type="text" value="Nueva Estadística" class="stat-label"></td>
            <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    }

    async function saveStats() {
        const rows = document.querySelectorAll('#statsTableBody tr');
        const stats = [];

        rows.forEach(row => {
            stats.push({
                number: row.querySelector('.stat-number').value,
                label: row.querySelector('.stat-label').value
            });
        });

        const statusMsg = document.getElementById('statusMessage');
        statusMsg.style.display = 'block';
        statusMsg.textContent = 'Guardando estadísticas...';
        statusMsg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/save_stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(stats)
            });

            const data = await response.json();

            if (data.success) {
                statusMsg.textContent = '¡Estadísticas guardadas correctamente!';
                statusMsg.classList.add('success');
                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            statusMsg.textContent = 'Error al guardar: ' + error.message;
            statusMsg.classList.add('error');
        }
    }


    function addGuest() {
        const tbody = document.getElementById('guestsTableBody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="Nuevo Invitado" class="guest-name"></td>
            <td><input type="text" value="Rol" class="guest-role"></td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                   <img src="/static/images/logo.webp" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" class="guest-preview" width="40" height="40">
                   <input type="file" onchange="uploadImage(this)" style="display: none;" class="file-input">
                   <button class="btn btn-save" onclick="this.previousElementSibling.click()" style="padding: 5px 10px; font-size: 0.8rem;">Subir</button>
                   <input type="hidden" value="logo.webp" class="guest-image">
                </div>
            </td>
            <td><input type="text" value="" class="guest-linkedin"></td>
            <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    }

    async function uploadImage(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const row = input.closest('tr');
        const hiddenInput = row.querySelector('.guest-image');
        const previewImg = row.querySelector('.guest-preview');
        const oldFilename = hiddenInput.value;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('old_filename', oldFilename);
        formData.append('csrf_token', getCsrfToken());

        // Visual feedback
        const msg = document.getElementById('statusMessage');
        msg.style.display = 'block';
        msg.textContent = 'Subiendo imagen...';
        msg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/upload_guest_image', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Update hidden input with new path
                hiddenInput.value = data.filepath;
                // Update preview
                previewImg.src = '/static/images/' + data.filepath;

                msg.textContent = 'Imagen subida. ¡No olvides pulsar "Guardar Cambios"!';
                msg.className = 'message success';

                // Highlight save button
                const saveBtn = document.querySelector('.btn-save');
                saveBtn.style.animation = "pulse 1.5s infinite";
                saveBtn.style.border = "2px solid #28a745";
            } else {
                throw new Error(data.error || 'Error al subir');
            }
        } catch (error) {
            msg.textContent = 'Error: ' + error.message;
            msg.classList.add('error');
        }
    }

    function deleteRow(btn) {
        if (confirm('¿Seguro que quieres eliminar este elemento?')) {
            btn.closest('tr').remove();
        }
    }

    // --- Collaborators Logic ---

    function addCollaborator() {
        const tbody = document.getElementById('collaboratorsTableBody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="Nueva Empresa" class="colab-name"></td>
            <td><input type="text" value="https://" class="colab-url"></td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                   <img src="/static/images/logo.webp" style="width: 40px; height: 40px; object-fit: contain; background: white; padding: 2px; border-radius: 4px;" class="colab-preview" width="40" height="40">
                   <input type="file" onchange="uploadCollaboratorImage(this)" style="display: none;" class="file-input">
                   <button class="btn btn-save" onclick="this.previousElementSibling.click()" style="padding: 5px 10px; font-size: 0.8rem;">Subir</button>
                   <input type="hidden" value="logo.webp" class="colab-image">
                </div>
            </td>
            <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    }

    async function uploadCollaboratorImage(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const row = input.closest('tr');
        const hiddenInput = row.querySelector('.colab-image');
        const previewImg = row.querySelector('.colab-preview');
        const oldFilename = hiddenInput.value;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('old_filename', oldFilename);
        formData.append('csrf_token', getCsrfToken());

        const msg = document.getElementById('statusMessage');
        msg.style.display = 'block';
        msg.textContent = 'Subiendo logo...';
        msg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/upload_collaborator_image', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                hiddenInput.value = data.filepath;
                previewImg.src = '/static/images/' + data.filepath;
                msg.textContent = 'Logo subido. ¡No olvides pulsar "Guardar Colaboradores"!';
                msg.className = 'message success';
            } else {
                throw new Error(data.error || 'Error al subir');
            }
        } catch (error) {
            msg.textContent = 'Error: ' + error.message;
            msg.classList.add('error');
        }
    }

    async function saveCollaborators() {
        const rows = document.querySelectorAll('#collaboratorsTableBody tr');
        const colabs = [];

        rows.forEach(row => {
            colabs.push({
                name: row.querySelector('.colab-name').value,
                url: row.querySelector('.colab-url').value,
                image: row.querySelector('.colab-image').value
            });
        });

        const statusMsg = document.getElementById('statusMessage');
        statusMsg.style.display = 'block';
        statusMsg.textContent = 'Guardando colaboradores...';
        statusMsg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/save_collaborators', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(colabs)
            });

            const data = await response.json();

            if (data.success) {
                statusMsg.textContent = '¡Colaboradores guardados correctamente!';
                statusMsg.classList.add('success');
                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            statusMsg.textContent = 'Error al guardar: ' + error.message;
            statusMsg.classList.add('error');
        }
    }

    // --- Newsletters Logic ---

    function addNewsletter() {
        const tbody = document.getElementById('newslettersTableBody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="NUEVO" class="news-badge"></td>
             <td>
                <select class="news-badge-class">
                    <option value="alert">Alert (Rojo)</option>
                    <option value="tech">Tech (Azul)</option>
                    <option value="compliance">Compliance (Verde)</option>
                    <option value="incident">Incidente (Naranja)</option>
                </select>
            </td>
            <td><input type="text" value="1 Enero 2025" class="news-date"></td>
            <td><input type="text" value="Título de la noticia" class="news-title"></td>
            <td><textarea class="news-desc" rows="3">Descripción...</textarea></td>
            <td>
                <textarea class="news-highlights" rows="3" placeholder="fas fa-icon|Texto\nfas fa-icon|Texto">fas fa-info-circle|Detalle importante</textarea>
            </td>
            <td><button class="btn btn-delete" onclick="deleteRow(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    }

    async function saveNewsletters() {
        const rows = document.querySelectorAll('#newslettersTableBody tr');
        const newsletters = [];

        rows.forEach((row, index) => {
            const rawHighlights = row.querySelector('.news-highlights').value;
            const highlights = [];

            rawHighlights.split('\\n').forEach(line => {
                if (line.includes('|')) {
                    const parts = line.split('|');
                    if (parts.length >= 2) {
                        highlights.push({
                            icon: parts[0].trim(),
                            text: parts.slice(1).join('|').trim()
                        });
                    }
                }
            });

            newsletters.push({
                id: index + 1, // Simple auto-increment based on order
                badge: row.querySelector('.news-badge').value,
                badge_class: row.querySelector('.news-badge-class').value,
                date: row.querySelector('.news-date').value,
                title: row.querySelector('.news-title').value,
                description: row.querySelector('.news-desc').value,
                highlights: highlights
            });
        });

        const statusMsg = document.getElementById('statusMessage');
        statusMsg.style.display = 'block';
        statusMsg.textContent = 'Guardando newsletters...';
        statusMsg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/save_newsletters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(newsletters)
            });

            const data = await response.json();

            if (data.success) {
                statusMsg.textContent = '¡Newsletters guardadas correctamente!';
                statusMsg.classList.add('success');
                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            statusMsg.textContent = 'Error al guardar: ' + error.message;
            statusMsg.classList.add('error');
        }
    }

    async function saveChanges() {
        const rows = document.querySelectorAll('#guestsTableBody tr');
        const guests = [];

        rows.forEach(row => {
            guests.push({
                name: row.querySelector('.guest-name').value,
                role: row.querySelector('.guest-role').value,
                image: row.querySelector('.guest-image').value,
                linkedin: row.querySelector('.guest-linkedin').value
            });
        });

        const statusMsg = document.getElementById('statusMessage');
        statusMsg.style.display = 'block';
        statusMsg.textContent = 'Guardando...';
        statusMsg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/save_guests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(guests)
            });

            const data = await response.json();

            if (data.success) {
                statusMsg.textContent = '¡Cambios guardados correctamente!';
                statusMsg.classList.add('success');
                setTimeout(() => {
                    statusMsg.style.display = 'none';
                }, 3000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            statusMsg.textContent = 'Error al guardar: ' + error.message;
            statusMsg.classList.add('error');
        }
    }

    // --- About Section Logic ---
    function addAboutParagraph() {
        const container = document.getElementById('aboutParagraphsContainer');
        const paragraphCount = container.querySelectorAll('.about-paragraph').length + 1;

        const div = document.createElement('div');
        div.style.marginBottom = '20px';
        div.innerHTML = `
            <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.7);">Párrafo ${paragraphCount}:</label>
            <textarea class="about-paragraph" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 4px; font-family: inherit; min-height: 100px;">Nuevo párrafo...</textarea>
            <button class="btn btn-delete" onclick="deleteAboutParagraph(this)" style="margin-top: 5px;">Eliminar Párrafo</button>
        `;
        container.appendChild(div);
    }

    function deleteAboutParagraph(btn) {
        if (confirm('¿Seguro que quieres eliminar este párrafo?')) {
            btn.closest('div').remove();

            // Renumerar los párrafos
            const labels = document.querySelectorAll('#aboutParagraphsContainer label');
            labels.forEach((label, index) => {
                label.textContent = `Párrafo ${index + 1}:`;
            });
        }
    }

    async function saveAbout() {
        const paragraphTextareas = document.querySelectorAll('.about-paragraph');
        const paragraphs = [];

        paragraphTextareas.forEach(textarea => {
            const text = textarea.value.trim();
            if (text) {
                paragraphs.push({ text: text });
            }
        });

        const aboutData = {
            paragraphs: paragraphs,
            award: {
                intro: document.getElementById('awardIntro').value,
                url: document.getElementById('awardUrl').value,
                title: document.getElementById('awardTitle').value,
                subtitle: document.getElementById('awardSubtitle').value
            }
        };

        const statusMsg = document.getElementById('statusMessage');
        statusMsg.style.display = 'block';
        statusMsg.textContent = 'Guardando sección "Quiénes Somos"...';
        statusMsg.className = 'message';

        try {
            const response = await fetch('/dashboard/api/save_about', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(aboutData)
            });

            const data = await response.json();

            if (data.success) {
                statusMsg.textContent = '¡Sección guardada correctamente!';
                statusMsg.classList.add('success');
                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            statusMsg.textContent = 'Error al guardar: ' + error.message;
            statusMsg.classList.add('error');
        }
    }
</script>
{% endblock %}